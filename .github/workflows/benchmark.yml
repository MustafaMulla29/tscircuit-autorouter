name: Autorouting Benchmark

on:
  issue_comment:
    types: [created]

jobs:
  benchmark:
    name: Run autorouting benchmark
    # Only run on PR comments with /benchmark command from maintainers
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/benchmark') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR branch and parse solver name
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

            // Parse solver name and scenario limit from comment: /benchmark [SolverName] [limit]
            // Examples: /benchmark, /benchmark SolverName, /benchmark SolverName 50, /benchmark _ 50
            const comment = context.payload.comment.body;
            const match = comment.match(/\/benchmark(?:\s+(\S+))?(?:\s+(\d+))?/);
            const solverName = match && match[1] && match[1] !== '_' ? match[1] : '';
            const scenarioLimit = match && match[2] ? match[2] : '20';
            core.setOutput('solver_name', solverName);
            core.setOutput('scenario_limit', scenarioLimit);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.ref }}

      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build autorouter
        run: bun run build

      - name: Install benchmark CLI
        run: bun add -g @tscircuit/autorouting-dataset-01

      - name: Create solver entry file
        run: |
          cat > benchmark-solver.ts << 'EOF'
          export * from "./lib"
          EOF

      - name: Run benchmark
        id: benchmark
        run: |
          SOLVER_NAME="${{ steps.pr-info.outputs.solver_name }}"
          SCENARIO_LIMIT="${{ steps.pr-info.outputs.scenario_limit }}"

          # Run benchmark with optional solver name
          if [ -n "$SOLVER_NAME" ]; then
            echo "Running benchmark with solver: $SOLVER_NAME (limit: $SCENARIO_LIMIT)"
            output=$(autorouting-dataset-runner benchmark-solver.ts "$SOLVER_NAME" --scenario-limit "$SCENARIO_LIMIT" 2>&1) || true
          else
            echo "Running benchmark with default solver (limit: $SCENARIO_LIMIT)"
            output=$(autorouting-dataset-runner benchmark-solver.ts --scenario-limit "$SCENARIO_LIMIT" 2>&1) || true
          fi
          echo "$output"

          # Save output for comment (escape for GitHub Actions)
          {
            echo "BENCHMARK_OUTPUT<<EOFMARKER"
            echo "$output"
            echo "EOFMARKER"
          } >> $GITHUB_OUTPUT

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: results/
          retention-days: 30

      - name: Update comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: Autorouting Benchmark
          number: ${{ github.event.issue.number }}
          message: |
            ## üèÉ Autorouting Benchmark Results

            ```
            ${{ steps.benchmark.outputs.BENCHMARK_OUTPUT }}
            ```

            üìä [Download HTML visualization and bundle](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)

            <sub>Triggered by @${{ github.event.comment.user.login }} ‚Ä¢ Commit: ${{ steps.pr-info.outputs.sha }}</sub>
